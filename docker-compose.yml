services:
  mediamtx:
    image: bluenviron/mediamtx:latest
    network_mode: host  # ← SOLUTION: Use host network for better external connectivity
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
          
  deepstream:
    image: nvcr.io/nvidia/deepstream:8.0-triton-multiarch
    command: tail -f /dev/null
    privileged: true
    network_mode: host  # ← KEY FIX: Container shares host network stack
    volumes:
      - ./:/workspace
    environment:
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,video,graphics,display
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    depends_on:
      mediamtx:
        condition: service_started
        
  # Triton Server SDK for testing
  triton-sdk:
    image: nvcr.io/nvidia/tritonserver:25.03-py3-sdk
    privileged: true
    command: tail -f /dev/null
    volumes:
      - ./:/workspace
    environment:
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,video,graphics
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    network_mode: host  # ← Host network for consistency
    restart: unless-stopped
    depends_on:
      deepstream:
        condition: service_started

# NOTE: With network_mode: host
# - Port mappings are not needed (services use host ports directly)
# - All services must use unique ports
# - Better external connectivity for RTSP streams
# - Services can access external IPs same as host machine